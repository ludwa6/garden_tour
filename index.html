<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Garden Tour App</title>
    <meta name="description" content="Interactive garden tour with plant information and iNaturalist integration">

    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4CAF50">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üå±</text></svg>">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
            animation: fadeInDown 0.8s ease-out;
        }

        .header h1 {
            font-size: clamp(2rem, 5vw, 2.5rem);
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .poi-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            animation: fadeInUp 0.6s ease-out;
            cursor: pointer;
        }

        .poi-card:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .poi-card.expanded {
            background: rgba(255, 255, 255, 0.2);
        }

        .poi-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .poi-card h2 {
            color: #4CAF50;
            font-size: 1.3rem;
            margin: 0;
        }

        .expand-icon {
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }

        .poi-card.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .poi-description {
            margin: 15px 0;
            font-size: 0.95rem;
            opacity: 0.9;
        }

        .poi-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .poi-card.expanded .poi-details {
            max-height: 500px;
        }

        .poi-meta {
            background: rgba(0,0,0,0.1);
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.9rem;
        }

        .poi-actions {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            cursor: pointer;
            white-space: nowrap;
        }

        .btn:hover {
            background: #45a049;
            transform: translateY(-1px);
        }

        .btn.secondary {
            background: #2196F3;
        }

        .btn.secondary:hover {
            background: #1976D2;
        }

        .btn.tertiary {
            background: #FF9800;
        }

        .btn.tertiary:hover {
            background: #F57C00;
        }

        .status {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: rgba(76, 175, 80, 0.2);
            border-radius: 10px;
            border: 1px solid rgba(76, 175, 80, 0.3);
            animation: slideIn 0.5s ease-out;
        }

        .status.poi-active {
            background: rgba(255, 193, 7, 0.2);
            border-color: rgba(255, 193, 7, 0.3);
        }

        .hidden {
            display: none;
        }

        .install-prompt {
            background: rgba(33, 150, 243, 0.2);
            border: 1px solid rgba(33, 150, 243, 0.3);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            margin: 20px;
            border: 1px solid rgba(255,255,255,0.2);
            transform: scale(0.8);
            transition: transform 0.3s ease;
        }

        .modal.active .modal-content {
            transform: scale(1);
        }

        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }

            .poi-actions {
                flex-direction: column;
            }

            .btn {
                text-align: center;
                justify-content: center;
            }
        }

        /* iNaturalist integration styles */
        .observe-btn {
          background: #74ac00;
        }

        .info-btn {
          background: #28a745;
        }

        .recent-obs-section {
          margin: 20px 0;
          padding: 15px;
          background: #f8f9fa;
          border-radius: 8px;
        }

        .observation-item {
          padding: 8px 0;
          border-bottom: 1px solid #dee2e6;
        }

        .observation-item:last-child {
          border-bottom: none;
        }

        .obs-species {
          font-weight: bold;
          color: #495057;
        }

        .obs-scientific {
          font-style: italic;
          color: #6c757d;
          font-size: 0.9em;
        }

        .obs-date, .obs-user {
          font-size: 0.9em;
          color: #6c7575;
        }

        .obs-meta {
          display: flex;
          gap: 10px;
          flex-wrap: wrap;
          margin-top: 5px;
        }

        .obs-distance {
          color: #28a745;
          font-size: 0.8em;
          font-weight: 500;
        }

        .obs-photo {
          margin-top: 8px;
        }

        .observation-item {
          display: flex;
          flex-direction: column;
          padding: 12px 0;
          border-bottom: 1px solid rgba(255,255,255,0.1);
          transition: background-color 0.2s ease;
        }

        .observation-item:hover {
          background-color: rgba(255,255,255,0.05);
          border-radius: 8px;
          padding-left: 8px;
          padding-right: 8px;
        }

        .observation-item:last-child {
          border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üå± Garden Tour</h1>
            <p><a href="javascript:void(0)" id="explore-link" style="color: #FFD700; text-decoration: underline; cursor: pointer; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">Discover the plants around you</a></p>
        </div>

        <div id="status" class="status hidden">
            <p>Loading...</p>
        </div>

        <div id="nearby-observations" class="poi-card" style="margin-bottom: 20px;">
            <div class="poi-header">
                <h2>üåç Nearby Nature Discoveries</h2>
                <button id="load-nearby-btn" class="btn" onclick="loadNearbyObservations()">
                    üìç Find What's Around Me
                </button>
            </div>
            <div id="nearby-content" class="poi-details">
                <p>Click the button above to see what plants and animals others have observed near your location!</p>
                <div id="nearby-observations-list"></div>
            </div>
        </div>

        <div id="poi-list">
            <div class="poi-card" data-poi="maple">
                <div class="poi-header">
                    <h2>üçÅ Red Maple</h2>
                    <span class="expand-icon">‚ñº</span>
                </div>
                <p class="poi-description">A beautiful deciduous tree known for its stunning fall colors. Native to eastern North America.</p>
                <div class="poi-details">
                    <div class="poi-meta">
                        <strong>Scientific Name:</strong> Acer rubrum<br>
                        <strong>Family:</strong> Sapindaceae<br>
                        <strong>Height:</strong> 40-60 feet<br>
                        <strong>Bloom Time:</strong> Early spring
                    </div>
                    <p>Red Maples are one of the most widespread trees in eastern North America. They're incredibly adaptable, growing in both wet swamps and dry uplands. In autumn, their leaves turn brilliant shades of yellow, orange, and red - often all three colors on the same tree!</p>
                    <div class="poi-actions">
                        <button onclick="identifyPlant('maple')" class="btn identify-btn">
                            üîç Identify with Seek
                        </button>
                        <button onclick="submitObservation('maple')" class="btn observe-btn">
                            üì∏ Submit to Garden Project
                        </button>
                        <button onclick="viewOnINaturalist('maple')" class="btn info-btn">
                            ‚ÑπÔ∏è View Species Info
                        </button>
                    </div>
                </div>
            </div>

            <div class="poi-card" data-poi="herbs">
                <div class="poi-header">
                    <h2>üåø Medicinal Herb Garden</h2>
                    <span class="expand-icon">‚ñº</span>
                </div>
                <p class="poi-description">A collection of healing plants used in traditional medicine for centuries.</p>
                <div class="poi-details">
                    <div class="poi-meta">
                        <strong>Featured Plants:</strong> Echinacea, Lavender, Chamomile<br>
                        <strong>Garden Type:</strong> Curated collection<br>
                        <strong>Best Season:</strong> Summer<br>
                        <strong>Uses:</strong> Traditional medicine, aromatherapy
                    </div>
                    <p>This garden showcases plants that have been used medicinally for thousands of years. From soothing chamomile to immune-boosting echinacea, these plants demonstrate the incredible pharmacy that nature provides. Please look but don't touch - many medicinal plants can be harmful if used incorrectly.</p>
                    <div class="poi-actions">
                        <button onclick="identifyPlant('herbs')" class="btn identify-btn">
                            üîç Identify with Seek
                        </button>
                        <button onclick="submitObservation('herbs')" class="btn observe-btn">
                            üì∏ Submit to Garden Project
                        </button>
                        <button onclick="viewOnINaturalist('herbs')" class="btn info-btn">
                            ‚ÑπÔ∏è View Species Info
                        </button>
                    </div>
                </div>
            </div>

            <div class="poi-card" data-poi="oak">
                <div class="poi-header">
                    <h2>üå≥ Oak Tree Grove</h2>
                    <span class="expand-icon">‚ñº</span>
                </div>
                <p class="poi-description">Ancient oak trees providing habitat for countless species of birds and insects.</p>
                <div class="poi-details">
                    <div class="poi-meta">
                        <strong>Scientific Name:</strong> Quercus species<br>
                        <strong>Age:</strong> 80-150 years<br>
                        <strong>Wildlife Supported:</strong> 500+ insect species<br>
                        <strong>Ecosystem Role:</strong> Keystone species
                    </div>
                    <p>These majestic oak trees are true ecosystem engineers. A single oak can support over 500 species of butterflies and moths alone! Their acorns feed squirrels, deer, and birds, while their bark and leaves host countless insects that in turn feed the birds. Notice the different shapes of leaves - we have several oak species here.</p>
                    <div class="poi-actions">
                        <button onclick="identifyPlant('oak')" class="btn identify-btn">
                            üîç Identify with Seek
                        </button>
                        <button onclick="submitObservation('oak')" class="btn observe-btn">
                            üì∏ Submit to Garden Project
                        </button>
                        <button onclick="viewOnINaturalist('oak')" class="btn info-btn">
                            ‚ÑπÔ∏è View Species Info
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for detailed information -->
    <div id="modal" class="modal" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div id="modal-content">
                <!-- Content will be inserted here -->
            </div>
            <button class="btn" onclick="closeModal()" style="margin-top: 20px;">Close</button>
        </div>
    </div>

    <!-- Exploration page modal -->
    <div id="explore-modal" class="modal" onclick="closeExploreModal()">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 700px; max-height: 80vh; overflow-y: auto;">
            <div id="explore-content">
                <h2>üåø Explore Garden Species</h2>
                <p>Discover what's been observed in our botanical garden:</p>
                <div id="species-loading">Loading species from iNaturalist...</div>
                <div id="species-list" style="display: none;"></div>
            </div>
            <button class="btn" onclick="closeExploreModal()" style="margin-top: 20px;">Close</button>
        </div>
    </div>

    <script src="js/inaturalist-api.js"></script>
    <script src="sw-register.js"></script>

    <script>
        // Define showExplorePage function first, before any inline onclick can call it
        function showExplorePage() {
            console.log('showExplorePage called'); // Debug log
            const modal = document.getElementById('explore-modal');
            if (modal) {
                modal.classList.add('active');
                console.log('Modal should be visible now'); // Debug log
                loadProjectSpecies();
            } else {
                console.error('explore-modal not found!');
            }
        }

        function closeExploreModal() {
            document.getElementById('explore-modal').classList.remove('active');
        }

        // POI data with iNaturalist IDs and coordinates
        const pois = [
            { id: 'maple', taxon_id: 47727, lat: 37.7749, lon: -122.4194 }, // Example coordinates
            { id: 'herbs', taxon_id: null, lat: 37.7750, lon: -122.4195 }, // Example coordinates
            { id: 'oak', taxon_id: 47851, lat: 37.7751, lon: -122.4196 }  // Example coordinates
        ];

        // Handle URL parameters for QR code scanning
        const urlParams = new URLSearchParams(window.location.search);
        const poiIdParam = urlParams.get('poi');

        if (poiIdParam) {
            document.getElementById('status').classList.remove('hidden');
            document.getElementById('status').classList.add('poi-active');
            document.getElementById('status').innerHTML = `<p>üéØ Viewing: ${poiIdParam.toUpperCase()}</p>`;

            // Auto-expand the relevant POI
            setTimeout(() => {
                const targetPOI = document.querySelector(`[data-poi="${poiIdParam}"]`);
                if (targetPOI) {
                    targetPOI.scrollIntoView({ behavior: 'smooth' });
                    togglePOI(targetPOI);
                }
            }, 500);
        }

        function togglePOI(element) {
            const isExpanded = element.classList.contains('expanded');

            // Close all other POIs
            document.querySelectorAll('.poi-card.expanded').forEach(card => {
                if (card !== element) {
                    card.classList.remove('expanded');
                }
            });

            // Toggle current POI
            element.classList.toggle('expanded');
        }

        function showPlantDetails(plant) {
            const details = {
                'maple': {
                    title: 'üçÅ Red Maple Deep Dive',
                    content: `
                        <h3>Identification Tips:</h3>
                        <ul>
                            <li>Leaves have 3-5 lobes with serrated edges</li>
                            <li>Bark is gray and smooth when young, becoming furrowed with age</li>
                            <li>Red flowers appear in early spring before leaves</li>
                            <li>Winged seeds (samaras) are bright red in summer</li>
                        </ul>
                        <h3>Ecological Importance:</h3>
                        <p>Red maples are pioneer species, often the first to colonize disturbed areas. They're crucial for forest succession and provide early nectar for pollinators when few other plants are blooming.</p>
                    `
                },
                'herbs': {
                    title: 'üåø Medicinal Garden Highlights',
                    content: `
                        <h3>Featured Plants:</h3>
                        <ul>
                            <li><strong>Echinacea (Purple Coneflower):</strong> Traditionally used to support immune system</li>
                            <li><strong>Lavender:</strong> Known for calming properties and aromatherapy</li>
                            <li><strong>Chamomile:</strong> Popular for tea and soothing preparations</li>
                            <li><strong>Yarrow:</strong> Historically used for wound healing</li>
                        </ul>
                        <h3>Important Note:</h3>
                        <p>These plants are for educational purposes only. Always consult healthcare professionals before using any plant medicinally.</p>
                    `
                },
                'oak': {
                    title: 'üå≥ Oak Grove Ecosystem',
                    content: `
                        <h3>Why Oaks Matter:</h3>
                        <ul>
                            <li>Support more wildlife than any other tree genus in North America</li>
                            <li>Produce acorns that feed over 100 vertebrate species</li>
                            <li>Host 500+ species of moths and butterflies</li>
                            <li>Can live 200-300 years or more</li>
                        </ul>
                        <h3>Species in This Grove:</h3>
                        <p>Look for differences in leaf shapes - some have rounded lobes (white oak group) while others have pointed, bristle-tipped lobes (red oak group).</p>
                    `
                }
            };

            const plant_data = details[plant];
            if (plant_data) {
                document.getElementById('modal-content').innerHTML = `
                    <h2>${plant_data.title}</h2>
                    ${plant_data.content}
                `;
                document.getElementById('modal').classList.add('active');
            }
        }

        function playAudio(plant) {
            // Simulate audio playback
            const audioMessages = {
                'maple': 'Now playing: "The Story of Red Maples" - Listen as we explore this remarkable tree...',
                'herbs': 'Now playing: "Traditional Medicine Garden" - Discover the healing power of plants...',
                'oak': 'Now playing: "Mighty Oaks and Their Ecosystem" - Learn about these forest giants...'
            };

            const statusDiv = document.getElementById('status');
            statusDiv.classList.remove('hidden');
            statusDiv.innerHTML = `<p>üîä ${audioMessages[plant]}</p>`;

            // Hide after 3 seconds
            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, 3000);
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        async function loadProjectSpecies() {
            const loadingDiv = document.getElementById('species-loading');
            const speciesDiv = document.getElementById('species-list');

            try {
                loadingDiv.textContent = 'Loading species from your garden project...';

                // Check if iNaturalist API is available
                if (!window.iNatAPI) {
                    throw new Error('iNaturalist API not loaded');
                }

                // Get species list from the project
                const species = await window.iNatAPI.getProjectSpecies();

                if (species && species.length > 0) {
                    loadingDiv.style.display = 'none';
                    speciesDiv.style.display = 'block';

                    speciesDiv.innerHTML = '<h3>Species Observed in Our Garden:</h3>';

                    species.forEach((item, index) => {
                        if (index < 20) { // Limit to top 20 species
                            const speciesItem = document.createElement('div');
                            speciesItem.className = 'observation-item';
                            speciesItem.style.cursor = 'pointer';

                            const taxon = item.taxon;
                            const commonName = taxon.preferred_common_name || taxon.name;
                            const scientificName = taxon.name;
                            const count = item.count;

                            speciesItem.innerHTML = `
                                <div class="obs-species">${commonName}</div>
                                ${commonName !== scientificName ? `<div class="obs-scientific">${scientificName}</div>` : ''}
                                <div class="obs-meta">
                                    <span class="obs-date">${count} observation${count > 1 ? 's' : ''}</span>
                                    ${taxon.default_photo ? `<img src="${taxon.default_photo.square_url}" alt="${commonName}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px; margin-left: 10px;">` : ''}
                                </div>
                            `;

                            speciesItem.onclick = () => {
                                window.open(`https://www.inaturalist.org/taxa/${taxon.id}`, '_blank');
                            };

                            speciesDiv.appendChild(speciesItem);
                        }
                    });

                    // Add link to full project
                    const projectLink = document.createElement('div');
                    projectLink.style.marginTop = '20px';
                    projectLink.innerHTML = `
                        <button class="btn" onclick="window.open('${window.iNatAPI.getProjectURL()}', '_blank')">
                            üîó View Full Project on iNaturalist
                        </button>
                    `;
                    speciesDiv.appendChild(projectLink);

                } else {
                    loadingDiv.innerHTML = `
                        <p>No species found in the project yet.</p>
                        <button class="btn" onclick="window.open('${window.iNatAPI.getProjectURL()}', '_blank')">
                            üîó Visit Project on iNaturalist
                        </button>
                    `;
                }

            } catch (error) {
                console.error('Error loading project species:', error);
                loadingDiv.innerHTML = `
                    <p style="color: #ff6b6b;">Unable to load species data. You can visit the project directly:</p>
                    <button class="btn" onclick="window.open('${window.iNatAPI.getProjectURL()}', '_blank')">
                        üîó Visit Project on iNaturalist
                    </button>
                `;
            }
        }

        // PWA installation prompt
        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;

            // Show install button
            const installDiv = document.createElement('div');
            installDiv.className = 'poi-card install-prompt';
            installDiv.innerHTML = `
                <div class="poi-header">
                    <h2>üì± Install Garden Tour App</h2>
                </div>
                <p class="poi-description">Add this garden tour to your home screen for offline access and a native app experience!</p>
                <div class="poi-actions">
                    <button class="btn" onclick="installApp()">üì≤ Install App</button>
                </div>
            `;
            document.getElementById('poi-list').prepend(installDiv);
        });

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                        document.querySelector('.install-prompt').style.display = 'none';
                    }
                    deferredPrompt = null;
                });
            }
        }

        // Add keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // Add live iNaturalist data to your app
        async function loadRecentObservations() {
          // Fetch observations from the ERC Vale da Lama project
          // Replace '153505' with your project ID if it differs
          const observations = await window.iNatAPI.getProjectObservations(153505, 5);
          const container = document.getElementById('recent-observations');

          if (container && observations.length > 0) {
            container.innerHTML = '<h3>Recent Garden Observations</h3>';
            observations.forEach(obs => {
              const obsDiv = document.createElement('div');
              obsDiv.className = 'observation-item';
              obsDiv.innerHTML = `
                <div class="obs-species">${obs.species_guess || 'Unknown species'}</div>
                <div class="obs-date">${new Date(obs.observed_on).toLocaleDateString()}</div>
                <div class="obs-user">by ${obs.user.login}</div>
              `;
              container.appendChild(obsDiv);
            });
          } else if (container) {
              container.innerHTML = '<h3>No recent observations found for this project.</h3>';
          }
        }

        // Load recent observations when page loads
        document.addEventListener('DOMContentLoaded', loadRecentObservations);

        async function loadNearbyObservations() {
          const button = document.getElementById('load-nearby-btn');
          const content = document.getElementById('nearby-content');
          const list = document.getElementById('nearby-observations-list');

          try {
            button.textContent = 'üìç Getting your location...';
            button.disabled = true;

            // Get user's location
            const location = await window.iNatAPI.getUserLocation();

            button.textContent = 'üîç Finding nearby observations...';

            // Fetch nearby observations (within 1km)
            const observations = await window.iNatAPI.getNearbyObservations(
              location.lat, 
              location.lng, 
              1, // 1km radius
              1, 
              10 // Show 10 observations
            );

            if (observations.length > 0) {
              list.innerHTML = '<h4>Recent observations within 1km:</h4>';
              observations.forEach(obs => {
                const obsDiv = document.createElement('div');
                obsDiv.className = 'observation-item';

                const speciesName = obs.species_guess || obs.taxon?.name || 'Unknown species';
                const commonName = obs.taxon?.preferred_common_name || '';
                const scientificName = obs.taxon?.name || '';
                const distance = obs.location ? `~${Math.round(obs.location.split(',').length > 1 ? 
                  calculateDistance(location.lat, location.lng, 
                    parseFloat(obs.location.split(',')[0]), 
                    parseFloat(obs.location.split(',')[1])) * 1000 : 0)}m away` : '';

                obsDiv.innerHTML = `
                  <div class="obs-species">${commonName || scientificName}</div>
                  ${commonName && scientificName ? `<div class="obs-scientific">${scientificName}</div>` : ''}
                  <div class="obs-meta">
                    <span class="obs-date">${new Date(obs.observed_on || obs.time_observed_at).toLocaleDateString()}</span>
                    <span class="obs-user">by ${obs.user.login}</span>
                    ${distance ? `<span class="obs-distance">${distance}</span>` : ''}
                  </div>
                  ${obs.photos && obs.photos.length > 0 ? 
                    `<div class="obs-photo"><img src="${obs.photos[0].url.replace('/square', '/small')}" alt="${speciesName}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px; margin-top: 5px;"></div>` : ''
                  }
                `;

                if (obs.uri) {
                  obsDiv.style.cursor = 'pointer';
                  obsDiv.onclick = () => window.open(obs.uri, '_blank');
                }

                list.appendChild(obsDiv);
              });

              // Auto-expand the section
              content.parentElement.classList.add('expanded');
            } else {
              list.innerHTML = '<p>No recent observations found within 1km of your location. Be the first to document nature here!</p>';
            }

            button.textContent = '‚úÖ Loaded nearby observations';
            setTimeout(() => {
              button.textContent = 'üîÑ Refresh nearby observations';
              button.disabled = false;
            }, 2000);

          } catch (error) {
            console.error('Error loading nearby observations:', error);
            list.innerHTML = `<p style="color: #ff6b6b;">Error: ${error.message}</p>`;
            button.textContent = '‚ùå Location access needed';
            button.disabled = false;
          }
        }

        // Helper function to calculate distance between two points
        function calculateDistance(lat1, lon1, lat2, lon2) {
          const R = 6371; // Radius of the Earth in km
          const dLat = (lat2 - lat1) * Math.PI / 180;
          const dLon = (lon2 - lon1) * Math.PI / 180;
          const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
          const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
          return R * c; // Distance in km
        }

        function submitObservation(poiId) {
          // Get POI data for coordinates and taxon info
          const poi = pois.find(p => p.id === poiId);
          let url = window.iNatAPI.getNewObservationURL();

          if (poi) {
            if (poi.taxon_id) {
              url = window.iNatAPI.getNewObservationURL(poi.taxon_id, poi.lat, poi.lon);
            } else if (poi.lat && poi.lon) {
              url = window.iNatAPI.getNewObservationURL(null, poi.lat, poi.lon);
            }
          }

          window.open(url, '_blank');
        }

        function viewOnINaturalist(poiId) {
          const poi = pois.find(p => p.id === poiId);
          if (poi && poi.taxon_id) {
            const url = `https://www.inaturalist.org/taxa/${poi.taxon_id}`;
            window.open(url, '_blank');
          } else {
            window.open(window.iNatAPI.getProjectURL(), '_blank');
          }
        }

        // Set up the explore link immediately since DOM is already ready
        console.log('Setting up explore link...'); // Debug log
        const exploreLink = document.getElementById('explore-link');
        console.log('Found explore link:', exploreLink); // Debug log
        if (exploreLink) {
            exploreLink.addEventListener('click', function(e) {
                console.log('Explore link clicked!'); // Debug log
                e.preventDefault();
                showExplorePage();
            });
            console.log('Click handler attached successfully'); // Debug log
        } else {
            console.error('explore-link element not found!');
        }

        console.log('üå± Garden Tour App loaded successfully!');
        console.log('Test with: ?poi=maple, ?poi=herbs, or ?poi=oak');
    </script>
</body>
</html>