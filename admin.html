<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <base href="/garden_tour/">
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    h1, h2 { text-align: center; }
    table { border-collapse: collapse; width: 100%; margin: 1rem 0; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: left; }
    th { background:#eee; }
    img { max-height: 50px; }
    .qr-inline { width: 60px; height: 60px; }
    button.delete-btn { background:#d33; color:white; border:none; padding:0.3rem 0.6rem; cursor:pointer; border-radius:4px; }
  </style>
</head>
<body>
  <h1>ğŸŒ¿ Admin Dashboard</h1>

  <!-- Registry Section -->
  <h2>POI Registry (from filtered selection)</h2>
  <input type="text" id="searchBox" placeholder="Filter by species or ID" style="width:100%;padding:0.5rem;">
  <table id="registryTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>Species</th>
        <th>QR</th>
        <th>Detail Page</th>
        <th>iNat Link</th>
        <th>Delete</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <p><a href="userjournals.html">ğŸ“’ View Visitor Journals</a></p>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
  <script>
    // Load registry from localStorage (set by qr_admin.html)
    function getRegistry() {
      const stored = localStorage.getItem("filteredRegistry");
      return stored ? JSON.parse(stored) : [];
    }

    function saveRegistry(data) {
      localStorage.setItem("filteredRegistry", JSON.stringify(data));
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "index.json";
      a.click();
      URL.revokeObjectURL(url);
      alert("Registry updated. Please replace /assets/qrcodes/index.json with the downloaded file.");
    }

    function renderRegistry() {
      const data = getRegistry();
      const tbody = document.querySelector("#registryTable tbody");
      tbody.innerHTML = "";

      data.forEach((item, index) => {
        const row = document.createElement("tr");

        // Inline QR: if PNG missing, generate dynamically
        let qrHtml = `<img src="${item.qr_code_url}" onerror="this.style.display='none';this.parentNode.querySelector('canvas').style.display='inline';">`;
        qrHtml += `<canvas class="qr-inline" data-url="${item.detail_url}" style="display:none"></canvas>`;

        row.innerHTML = `
          <td>${item.poi_id}</td>
          <td>${item.species_name}</td>
          <td>${qrHtml}</td>
          <td><a href="${item.detail_url}">View</a></td>
          <td><a href="${item.inat_url}" target="_blank">iNat</a></td>
          <td><button class="delete-btn" data-index="${index}">Delete</button></td>
        `;
        tbody.appendChild(row);
      });

      // Generate fallback inline QRs
      document.querySelectorAll("canvas[data-url]").forEach(canvas => {
        new QRious({
          element: canvas,
          value: canvas.dataset.url,
          size: 60
        });
      });

      // Enable filtering
      const searchBox = document.getElementById("searchBox");
      searchBox.addEventListener("input", () => {
        const filter = searchBox.value.toLowerCase();
        Array.from(tbody.rows).forEach(row => {
          const text = row.innerText.toLowerCase();
          row.style.display = text.includes(filter) ? "" : "none";
        });
      });

      // Handle delete buttons
      tbody.querySelectorAll(".delete-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const index = parseInt(btn.dataset.index);
          const data = getRegistry();
          data.splice(index, 1);
          saveRegistry(data);
          renderRegistry();
        });
      });
    }

    renderRegistry();
  </script>

<!-- Common Navigation Bar -->
  <nav style="
    position:fixed; bottom:0; left:0; right:0;
    background:#2c7; color:white;
    display:flex; justify-content:space-around;
    padding:0.6em 0; font-size:0.9rem;
    box-shadow:0 -2px 4px rgba(0,0,0,0.2);
    z-index:999;">
    <a href="index.html" style="color:white; text-decoration:none;">ğŸ¡ Home</a>
    <a href="tripplan.html" style="color:white; text-decoration:none;">ğŸŒ¿ My Trip</a>
    <a href="poi/detail.html?obs=123456" style="color:white; text-decoration:none;">ğŸ” Sample POI</a>
    <a href="admin.html" style="color:white; text-decoration:none;">âš™ï¸ Admin</a>
    <a href="userjournals.html" style="color:white; text-decoration:none;">ğŸ“’ Journals</a>
    <a href="qr_admin.html" style="color:white; text-decoration:none;">ğŸ”— QR Admin</a>
  </nav>

  <div style="height:3.5rem;"></div>
</body>
</html>