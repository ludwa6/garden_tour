<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    h1, h2 { text-align: center; }
    table { border-collapse: collapse; width: 100%; margin: 1rem 0; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: left; }
    th { background:#eee; }
    img { max-height: 50px; }
    .qr-inline { width: 60px; height: 60px; }
  </style>
</head>
<body>
  <h1>üåø Admin Dashboard</h1>

  <!-- Registry Section -->
  <h2>POI Registry</h2>
  <input type="text" id="searchBox" placeholder="Filter by species or ID" style="width:100%;padding:0.5rem;">
  <table id="registryTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>Species</th>
        <th>QR</th>
        <th>Detail Page</th>
        <th>iNat Link</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <p><a href="userjournals.html">üìí View Visitor Journals</a></p>

  <!-- Visitor Notes Section -->
  <h2>Visitor Notes (Shared with Garden)</h2>
  <table id="notesTable"><tr><td>Loading...</td></tr></table>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
  <script>
    // -------------------
    // Load POI Registry
    // -------------------
    async function loadRegistry() {
      try {
        const res = await fetch("/assets/qrcodes/index.json");
        const data = await res.json();
        const tbody = document.querySelector("#registryTable tbody");
        tbody.innerHTML = "";

        data.forEach(item => {
          const row = document.createElement("tr");

          // Inline QR: if PNG missing, generate dynamically
          let qrHtml = `<img src="${item.qr_code_url}" onerror="this.style.display='none';this.parentNode.querySelector('canvas').style.display='inline';">`;
          qrHtml += `<canvas class="qr-inline" data-url="${item.detail_url}" style="display:none"></canvas>`;

          row.innerHTML = `
            <td>${item.poi_id}</td>
            <td>${item.species_name}</td>
            <td>${qrHtml}</td>
            <td><a href="${item.detail_url}">View</a></td>
            <td><a href="${item.inat_url}" target="_blank">iNat</a></td>
          `;
          tbody.appendChild(row);
        });

        // Generate fallback inline QRs
        document.querySelectorAll("canvas[data-url]").forEach(canvas => {
          const qr = new QRious({
            element: canvas,
            value: canvas.dataset.url,
            size: 60
          });
        });

        // Enable filtering
        const searchBox = document.getElementById("searchBox");
        searchBox.addEventListener("input", () => {
          const filter = searchBox.value.toLowerCase();
          Array.from(tbody.rows).forEach(row => {
            const text = row.innerText.toLowerCase();
            row.style.display = text.includes(filter) ? "" : "none";
          });
        });

      } catch (err) {
        console.error("Failed to load registry", err);
      }
    }

    // -------------------
    // Load Visitor Notes
    // -------------------
    async function loadSharedNotes() {
      const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQOnNZh3kF5CzHEEOf6OH8pp9XT-VVS10ELP6RapiD0v2a--ybmB09LFFfFJ8VawBnVe6JI6mESYn-u/pub?gid=0&single=true&output=csv"; // Replace with your published CSV link
      try {
        const res = await fetch(url);
        const text = await res.text();
        const rows = text.split("\n").map(r => r.split(","));

        const table = document.getElementById("notesTable");
        table.innerHTML = "<tr><th>POI</th><th>Species</th><th>Note</th><th>Date</th></tr>";

        rows.slice(1).forEach(r => {
          if (r[0]) {
            table.innerHTML += `<tr>
              <td>${r[0]}</td>
              <td>${r[1]}</td>
              <td>${r[2]}</td>
              <td>${r[4]}</td>
            </tr>`;
          }
        });
      } catch (err) {
        console.error("Failed to load notes", err);
        document.getElementById("notesTable").innerHTML =
          "<tr><td colspan='4'>‚ö†Ô∏è Could not load shared notes.</td></tr>";
      }
    }

    // Init
    loadRegistry();
    loadSharedNotes();
  </script>
</body>
</html>
