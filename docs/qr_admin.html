<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QR Admin</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    h1 { text-align: center; }
    #preview { margin-top: 1rem; text-align: center; }
    #preview img { max-width: 200px; display:block; margin:0 auto; }
    #preview p { margin: 0.5rem 0; }
    select, button { padding:0.5rem; margin:0.5rem 0; }
  </style>
</head>
<body>
  <h1>🔗 QR Admin</h1>

  <label for="obsSelect">Select Observation:</label>
  <select id="obsSelect"></select>
  <button id="genBtn">Generate QR</button>

  <div id="preview"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
  <script>
    // Example: Populate dropdown with observations from index.json
    async function loadObservations() {
      try {
        const res = await fetch('/assets/qrcodes/index.json');
        const data = await res.json();
        const sel = document.getElementById('obsSelect');
        sel.innerHTML = '';
        data.forEach(obs => {
          const opt = document.createElement('option');
          opt.value = obs.poi_id;
          opt.textContent = `${obs.species_name} (${obs.poi_id})`;
          sel.appendChild(opt);
        });
      } catch (e) {
        console.error('Failed to load observations', e);
      }
    }

    // Get and update filteredRegistry in localStorage
    function getRegistry() {
      const stored = localStorage.getItem('filteredRegistry');
      return stored ? JSON.parse(stored) : [];
    }
    function saveRegistry(data) {
      localStorage.setItem('filteredRegistry', JSON.stringify(data));
    }

    document.getElementById('genBtn').addEventListener('click', () => {
      const sel = document.getElementById('obsSelect');
      const obsId = sel.value;
      const obsText = sel.options[sel.selectedIndex].text;

      const detailUrl = `/poi/detail.html?obs=${obsId}`;
      const qr = new QRious({ value: location.origin + detailUrl, size: 200 });
      const qrDataUrl = qr.toDataURL();

      document.getElementById('preview').innerHTML = `
        <img src="${qrDataUrl}" alt="QR Code">
        <p>ID: ${obsId}</p>
        <p><a href="${detailUrl}">Go to Detail Page</a></p>
      `;

      // Update registry in localStorage
      let registry = getRegistry();
      // Avoid duplicates
      if (!registry.find(r => r.poi_id == obsId)) {
        registry.push({
          poi_id: obsId,
          species_name: obsText.split(' (')[0],
          qr_code_url: qrDataUrl,
          detail_url: detailUrl,
          inat_url: `https://www.inaturalist.org/observations/${obsId}`
        });
        saveRegistry(registry);
        alert('POI saved to local registry and available in Admin Dashboard.');
      }
    });

    loadObservations();
  </script>

  <!-- Common Navigation Bar -->
  <nav style="
    position:fixed; bottom:0; left:0; right:0;
    background:#2c7; color:white;
    display:flex; justify-content:space-around;
    padding:0.6em 0; font-size:0.9rem;
    box-shadow:0 -2px 4px rgba(0,0,0,0.2);
    z-index:999;">
    <a href="/index.html" style="color:white; text-decoration:none;">🏡 Home</a>
    <a href="/tripplan.html" style="color:white; text-decoration:none;">🌿 My Trip</a>
    <a href="/admin.html" style="color:white; text-decoration:none;">⚙️ Admin</a>
    <a href="/userjournals.html" style="color:white; text-decoration:none;">📒 Journals</a>
    <a href="/qr_admin.html" style="color:white; text-decoration:none;">🔗 QR Admin</a>
  </nav>
  <div style="height:3.5rem;"></div>
</body>
</html>