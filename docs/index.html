<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nature Connection Guide</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css">
  <style>
    body, html { margin: 0; padding: 0; height: 100%; }
    #map { height: calc(100% - 50px); width: 100%; }
    .footer {
      height: 50px;
      background: #2e7d32;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1em;
      font-size: 0.9em;
    }
    .footer a {
      color: white;
      text-decoration: none;
    }
    .footer-sep {
      color: #a5d6a7;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <header class="header">
    <h1>Nature Connection Explorer</h1>
    <p>Discover and log your biodiversity observations</p>
  </header>

  <main class="main-content">
    <!-- Map container -->
    <div id="map" style="height: 70vh; width: 100%;"></div>

    <!-- Action buttons -->
    <div class="actions">
      <a href="tripplan.html" class="btn">View Trip Plan</a>
    </div>
  </main>

  <script>
    let map = L.map('map').setView([39.5, -8.0], 7);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let markers = L.markerClusterGroup();
    let observations = [];

    // Load observations from inaturalist project (static API endpoint example)
    async function loadObservations() {
      try {
        const resp = await fetch("https://api.inaturalist.org/v1/observations?project_id=197410&per_page=200");
        const data = await resp.json();
        observations = data.results.map(obs => {
          return {
            id: obs.id,
            lat: obs.geojson.coordinates[1],
            lng: obs.geojson.coordinates[0],
            species: obs.taxon ? obs.taxon.name : "Unknown",
            url: obs.uri,
            thumb: obs.photos[0] ? obs.photos[0].url.replace("square", "small") : null
          };
        });

        observations.forEach(obs => {
          const marker = L.marker([obs.lat, obs.lng]);
          let popup = `<b>${obs.species}</b><br>
                       <a href="${obs.url}" target="_blank">View on iNat</a>`;
          if (obs.thumb) {
            popup = `<img src="${obs.thumb}" style="width:100px"><br>` + popup;
          }
          marker.bindPopup(popup);
          markers.addLayer(marker);
        });

        map.addLayer(markers);
      } catch (err) {
        console.error("Failed to load observations", err);
      }
    }

    loadObservations();
  </script>


    <footer class="footer">
      <a href="qr_admin.html" id="qr-admin-link">QR Admin</a>
      <a href="admin.html">ðŸ”§ Admin Dashboard</a>
      <span class="footer-sep"> :: </span>
      <a href="https://www.inaturalist.org/projects/197410" 
         target="_blank" rel="noopener noreferrer">
        View Project at iNaturalist
      </a>
    </footer>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>
    <script src="app.js"></script>
    <script>
      // When navigating to QR Admin, pass filtered observations
      document.getElementById('qr-admin-link').addEventListener('click', (e) => {
        e.preventDefault();
        const filtered = (window.observations || []).filter(obs => obs.isVisible);
        localStorage.setItem("filteredObservations", JSON.stringify(filtered));
        window.location.href = "qr_admin.html";
      });
    </script>
  </body>
</html>
