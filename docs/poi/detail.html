<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>POI Detail</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    img { max-width: 100%; border-radius: 6px; }
    textarea { width: 100%; margin: 0.5rem 0; }
    button { margin-top: 0.5rem; padding: 0.4rem 0.8rem; }
    .note-card { border: 1px solid #ccc; border-radius: 6px; padding: 0.5rem; margin: 0.5rem 0; }
    .note-card img { max-width: 100px; float: right; margin-left: 0.5rem; }
  </style>
</head>
<body>
  <h1 id="speciesName">Loadingâ€¦</h1>
  <img id="speciesImage" alt="Species image">

  <!-- Save for Offline -->
  <button id="saveOfflineBtn">â­ Save for Offline</button>

  <!-- Add Note -->
  <div id="noteSection" style="margin-top:1rem;">
    <button id="addNoteBtn">ğŸ“ Add Note</button>
    <div id="noteForm" style="display:none; margin-top:0.5rem;">
      <textarea id="noteInput" rows="3" placeholder="What did you notice or feel here?"></textarea>
      <br>
      <label>ğŸ“¸ Add Photo (optional): <input type="file" id="photoInput" accept="image/*"></label>
      <br>
      <button id="saveNoteBtn">ğŸ’¾ Save Note</button>
    </div>
  </div>

  <!-- Notes List -->
  <h3 style="margin-top:1.5rem;">ğŸ“ My Notes for this Spot</h3>
  <ul id="noteList" style="list-style:none; padding:0;"></ul>

  <!-- Trip Plan link -->
  <div style="margin-top:2rem; text-align:center;">
    <a href="/tripplan.html" style="
      display:inline-block;
      padding:0.6em 1.2em;
      background:#2c7;
      color:white;
      border-radius:8px;
      text-decoration:none;
      font-weight:bold;">
      ğŸŒ¿ View My Trip Plan
    </a>
  </div>

  <script>
    const obsId = new URLSearchParams(window.location.search).get("obs");

    // fake placeholders (replace with iNat fetch later if desired)
    document.getElementById("speciesName").innerText = "Observation " + obsId;
    document.getElementById("speciesImage").src = "https://placehold.co/400x300?text=Obs+" + obsId;

    // Save for Offline stub
    document.getElementById("saveOfflineBtn").addEventListener("click", () => {
      caches.open("fieldguide-cache").then(cache => {
        cache.add(location.href);
      });
      alert("âœ… Saved for offline use!");
    });

    // Add Note
    const addNoteBtn = document.getElementById("addNoteBtn");
    const noteForm = document.getElementById("noteForm");
    const saveNoteBtn = document.getElementById("saveNoteBtn");

    addNoteBtn.addEventListener("click", () => {
      noteForm.style.display = noteForm.style.display === "none" ? "block" : "none";
    });

    saveNoteBtn.addEventListener("click", async () => {
      const noteText = document.getElementById("noteInput").value.trim();
      const photoFile = document.getElementById("photoInput").files[0];
      let photoData = null;
      if (photoFile) photoData = await toBase64(photoFile);

      const entry = {
        poi_id: String(obsId),
        species_name: document.getElementById("speciesName").innerText,
        image: document.getElementById("speciesImage").src,
        note: noteText,
        photo: photoData,
        date_saved: new Date().toISOString()
      };

      const existing = JSON.parse(localStorage.getItem("tripPlan") || "[]");
      existing.push(entry);
      localStorage.setItem("tripPlan", JSON.stringify(existing));

      alert("âœ… Saved to My Trip Plan!");
      noteForm.style.display = "none";
      document.getElementById("noteInput").value = "";
      document.getElementById("photoInput").value = "";
      renderNotes();
    });

    function toBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // Render notes for this POI
    function renderNotes() {
      const all = JSON.parse(localStorage.getItem("tripPlan") || "[]");
      const mine = all.filter(poi => String(poi.poi_id) === String(obsId));
      const list = document.getElementById("noteList");
      list.innerHTML = "";

      if (mine.length === 0) {
        list.innerHTML = "<li><em>No notes yet. Add one above!</em></li>";
        return;
      }

      mine.forEach((poi, idx) => {
        const li = document.createElement("li");
        li.className = "note-card";
        li.innerHTML = `
          ${poi.photo ? `<img src="${poi.photo}">` : ""}
          <p><strong>${new Date(poi.date_saved).toLocaleString()}</strong></p>
          ${poi.note ? `<p>${poi.note}</p>` : "<p><em>(no text)</em></p>"}
          <button data-idx="${idx}" class="deleteNoteBtn">âŒ Delete</button>
        `;
        list.appendChild(li);
      });

      // delete logic
      document.querySelectorAll(".deleteNoteBtn").forEach((btn, i) => {
        btn.addEventListener("click", () => {
          const all = JSON.parse(localStorage.getItem("tripPlan") || "[]");
          const filtered = all.filter(poi => !(String(poi.poi_id) === String(obsId) && poi.date_saved === mine[i].date_saved));
          localStorage.setItem("tripPlan", JSON.stringify(filtered));
          renderNotes();
        });
      });
    }

    renderNotes();
  </script>
</body>
</html>
