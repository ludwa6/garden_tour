<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>POI Detail</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../style.css?v=1">
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    header { margin-bottom: 1rem; }
    img { max-width: 100%; border-radius: 8px; margin: 1em 0; }
    button { padding: 0.5em 1em; border: none; border-radius: 6px; cursor: pointer; }
    button#save-offline { background: #2c7; color: white; }
  </style>
</head>
<body>
  <header>
    <a href="../index.html">‚Üê Back to Map</a>
    <h1 id="species-name">Loading...</h1>
  </header>

  <main>
    <img id="species-photo" alt="Observation photo">
    <p><strong>Date:</strong> <span id="date-observed"></span></p>
    <p><strong>Location:</strong> <span id="location"></span></p>
    <p><a id="inat-link" href="#" target="_blank">View on iNaturalist</a></p>
  </main>

  <footer>
    <button id="save-offline">‚≠ê Save for Offline</button>
  </footer>

  <script>
    // --- Utility: read ?obs=123456 from URL
    function getObservationId() {
      const params = new URLSearchParams(window.location.search);
      return params.get("obs");
    }

    // --- Load observation data from iNat
    async function loadObservation(obsId) {
      const apiUrl = `https://api.inaturalist.org/v1/observations/${obsId}`;

      try {
        const response = await fetch(apiUrl);
        const data = await response.json();
        const obs = data.results[0];

        // Populate template
        document.getElementById("species-name").textContent =
          obs.taxon?.name || obs.species_guess || "Unknown species";
        document.getElementById("species-photo").src =
          obs.photos?.[0]?.url.replace("square", "medium") || "";
        document.getElementById("date-observed").textContent = obs.observed_on || "";
        document.getElementById("location").textContent = obs.location || "‚Äî";
        document.getElementById("inat-link").href = obs.uri;

        // Save reference for offline
        window.currentObservation = {
          id: obsId,
          name: obs.taxon?.name || obs.species_guess,
          date: obs.observed_on,
          location: obs.location,
          photo: obs.photos?.[0]?.url,
          inatUrl: obs.uri
        };
      } catch (err) {
        console.error("Failed to load observation", err);
        document.getElementById("species-name").textContent = "‚ö†Ô∏è Offline ‚Äì data not available";
      }
    }

// --- Save for offline using Service Worker
  document.getElementById("save-offline").addEventListener("click", async () => {
    const obs = window.currentObservation;
    if (obs && navigator.serviceWorker.controller) {
      const jsonUrl = `https://api.inaturalist.org/v1/observations/${obs.id}`;
      const photoUrl = obs.photo?.replace("square", "medium");
      navigator.serviceWorker.controller.postMessage({
        type: "CACHE_POI",
        obsId: obs.id,
        jsonUrl,
        photoUrl
      });
      alert(`Saved ${obs.name} for offline use`);
    } else {
      alert("‚ö†Ô∏è Service Worker not ready ‚Äì cannot save offline.");
    }
  });


    // --- Boot
    const obsId = getObservationId();
    if (obsId) {
      loadObservation(obsId);
    } else {
      document.getElementById("species-name").textContent = "No observation ID given";
    }
  </script>

<!-- Add Note UI -->
<div id="noteSection" style="margin-top:1rem;">
  <button id="addNoteBtn">üìù Add Note</button>
  <div id="noteForm" style="display:none; margin-top:0.5rem;">
    <textarea id="noteInput" rows="3" placeholder="What did you notice or feel here?" style="width:100%;"></textarea>
    <br>
    <label>üì∏ Add Photo (optional): <input type="file" id="photoInput" accept="image/*"></label>
    <br>
    <button id="saveNoteBtn">üíæ Save Note</button>
  </div>
</div>

<script>
  const addNoteBtn = document.getElementById("addNoteBtn");
  const noteForm = document.getElementById("noteForm");
  const saveNoteBtn = document.getElementById("saveNoteBtn");

  addNoteBtn.addEventListener("click", () => {
    noteForm.style.display = noteForm.style.display === "none" ? "block" : "none";
  });

  saveNoteBtn.addEventListener("click", async () => {
    const noteText = document.getElementById("noteInput").value.trim();
    const photoFile = document.getElementById("photoInput").files[0];
    let photoData = null;

    if (photoFile) {
      photoData = await toBase64(photoFile);
    }

    const obsId = new URLSearchParams(window.location.search).get("obs");
    const speciesName = document.querySelector("h1")?.innerText || "Unknown species"; 
    const image = document.querySelector("img")?.src || "";

    const entry = {
      poi_id: obsId,
      species_name: speciesName,
      image: image,
      note: noteText,
      photo: photoData,
      date_saved: new Date().toISOString()
    };

    const existing = JSON.parse(localStorage.getItem("tripPlan") || "[]");
    existing.push(entry);
    localStorage.setItem("tripPlan", JSON.stringify(existing));

    alert("‚úÖ Saved to My Trip Plan!");
    noteForm.style.display = "none";
    document.getElementById("noteInput").value = "";
    document.getElementById("photoInput").value = "";
  });

  function toBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }
</script>


</body>
</html>
